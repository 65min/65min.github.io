<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title></title>
  <script type="text/javascript" src="../internal.js"></script>
  <script type="text/javascript" src="../extend.js"></script>
  <script type="text/javascript" src="../sha1.js"></script>
  <style type="text/css">
    .content{
      height: 415px;
      margin: 20px;
    }
    .content table{width: 100%}
    .content table td{vertical-align: middle; padding: 5px;}

    input{
      height: 26px;
      background: #FFF;
      border: 1px solid #ccc;
      line-height: 26px;
      border-radius: 5px;
      margin-left: 5px;
    }
  </style>
</head>
<body>
<div class="content">
  <table>
    <tr>
      <td><var id="_controlname"></var>:</td>
      <td><input id="controlname" type="text" /></td>
    </tr>
    <tr>
      <td><var id="_defaultvalue"></var>:</td>
      <td><input id="defaultvalue" type="text" /></td>
    </tr>
    <tr>
      <td><var id="_controlwidth"></var>:</td>
      <td><input id="controlwidth" type="text" /></td>
    </tr>
  </table>
  <div style="width:100%;height:363px;margin:20px auto;border:none" id="container"></div>

</div>
<script type="text/javascript">

</script>
<script type="text/javascript">

  var oNode = null,thePlugins = 'controlinput';
  console.log(thePlugins)
  window.onload = function() {
    if( UE.plugins[thePlugins].editdom ){
      oNode = UE.plugins[thePlugins].editdom;
      var gValue = '';
      if(oNode.getAttribute('value'))
        gValue = oNode.getAttribute('value').replace(/&quot;/g,"\"");
      var gTitle=oNode.getAttribute('title').replace(/&quot;/g,"\""),gWidth=oNode.getAttribute('cwidth');
      gValue = gValue==null ? '' : gValue;
      gTitle = gTitle==null ? '' : gTitle;
      $G('defaultvalue').value = gValue;
      $G('controlname').value = gTitle;
      $G('controlwidth').value = gWidth;
    }

    // 去除控件名称中的半角字符
    // 验证名称是否重复
    $G('controlname').onchange = function() {

      // 去除控件名称中的半角字符
      var orgname = $G('controlname').value;
      orgname = orgname.replace(/[\u0000-\u002F]/gi, '').replace(/[\u003a-\u0040]/gi, '').replace(/[\u005b-\u0060]/gi, '').replace(/[\u007b-\u00ff]/gi, '');
      $G('controlname').value = orgname;

      // 验证名称是否重复
      // if (orgname) {
      //
      //   for (var i = 0; i < UE.controls.length; i++) {
      //     var name = UE.controls[i];
      //     if(name == orgname) {
      //       alert('控件名称重复，请重新输入！');
      //       $(this).val('');
      //       return false;
      //     }
      //   }
      // }
    }

    if(null != null) {
      var orgname = oNode.getAttribute('title').replace(/&quot;/g, "\"");
      for (var i = 0; i < UE.controls.length; i++) {

        var name = UE.controls[i];
        if (name == orgname) {
          UE.controls.splice(i, 1, '');
          break;
        }
      }
    }
  }
  dialog.oncancel = function () {
    if( UE.plugins[thePlugins].editdom ) {
      delete UE.plugins[thePlugins].editdom;
    }
  };
  dialog.onok = function (){
    if($G('controlname').value==''){
      alert('请输入控件名称');
      return false;
    }
    var gValue=$G('defaultvalue').value.replace(/\"/g,"&quot;"),gTitle=$G('controlname').value.replace(/\"/g,"&quot;"),gWidth=$G('controlwidth').value;

    if( !oNode ) {
      try {
        oNode = createElement('input',getComplexRandomID('32'));
        oNode.setAttribute('type','text');
        oNode.setAttribute('title', gTitle);
        oNode.setAttribute('agentitemid', hex_sha1(gTitle));
        oNode.setAttribute('value',gValue);
        oNode.setAttribute('name', getComplexRandomID(32));
        oNode.setAttribute('plugins',thePlugins);

        if( gWidth != '' ) {
          oNode.style.width = gWidth+ 'px';
          oNode.setAttribute('cwidth',gWidth );
        }else{
          oNode.style.width = '';
          oNode.setAttribute('cwidth', '');
        }
        oNode.readOnly = true

        editor.execCommand('insertHtml',oNode.outerHTML, true);
      } catch (e) {
        try {
          console.log(e)
          UE.getEditor('fe-ueditor').execCommand('error');
        } catch ( e ) {
          alert('控件异常，如果一直出现该提示，请联系系统管理员！');
        }
        return false;
      }
    } else {

      oNode.setAttribute('title', gTitle);
      oNode.setAttribute('agentitemid', hex_sha1(gTitle));
      oNode.setAttribute('value', $G('defaultvalue').value);

      if( gWidth != '' ) {
        oNode.style.width = gWidth+ 'px';
        oNode.setAttribute('cwidth',gWidth );
      }else{
        oNode.style.width = '';
        oNode.setAttribute('cwidth', '');
      }
      oNode.readOnly = true

      delete UE.plugins[thePlugins].editdom;
    }
  };
</script>


</body>
</html>
